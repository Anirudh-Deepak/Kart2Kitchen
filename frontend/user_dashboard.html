<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard</title>
<style>
body { font-family: Arial; background:#f2f2f2; padding:20px; margin:0;}
.container { background:#fff; padding:20px; border-radius:10px; max-width:1100px; margin:auto; box-shadow:0 5px 15px rgba(0,0,0,0.2);}
h2 { margin-bottom:10px; color:#333; }
p { font-size: 16px; margin: 5px 0 15px 0; }
.filters { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:20px; }
.filters input { padding:10px; border:1px solid #ccc; border-radius:5px; font-size:14px; }
.layout { display:grid; grid-template-columns: 2fr 1fr; gap:20px; }
table { width:100%; border-collapse: collapse; }
th, td { padding:10px; border:1px solid #ccc; text-align:left; }
th { background:#007bff; color:#fff; }
tr:nth-child(even) { background:#f9f9f9; }
button { padding:8px 12px; border:none; border-radius:5px; background:#28a745; color:#fff; cursor:pointer; font-size:14px; }
button:hover { background:#218838; }
.cart { background:#fafafa; border:1px solid #ddd; border-radius:8px; padding:15px; }
.cart h3 { margin-top:0; }
.cart-item { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px dashed #ddd; }
.cart-item:last-child { border-bottom:none; }
.cart button { background:#6c757d; }
.cart button:hover { background:#5a6268; }
.cart .checkout { background:#007bff; margin-top:10px; }
.cart .checkout:hover { background:#0056b3; }

/* ✅ Responsive styles */
@media (max-width: 768px) {
  .filters {
    grid-template-columns: 1fr; /* stack filters vertically */
  }
  .layout {
    grid-template-columns: 1fr; /* stack cart under table */
  }
  table, th, td {
    font-size: 12px; /* smaller text */
  }
  table {
    display: block;
    overflow-x: auto; /* horizontal scroll if too wide */
    white-space: nowrap;
  }
  button {
    font-size: 12px;
    padding:6px 10px;
  }
}
</style>
</head>
<body>
<div class="container">
    <h2 id="welcomeText"></h2>
    <p>Phone: <span id="userPhone"></span></p>

    <div class="filters">
        <input type="text" id="fVeg" placeholder="Filter by vegetable (e.g., Tomato)">
        <input type="text" id="fLocality" placeholder="Filter by locality">
        <input type="number" id="fMinRate" placeholder="Min rate" min="0" step="0.5">
        <input type="number" id="fMaxRate" placeholder="Max rate" min="0" step="0.5">
    </div>

    <div class="layout">
      <div>
        <table>
          <thead>
            <tr>
              <th>Vegetable</th>
              <th>Rate</th>
              <th>Area</th>
              <th>Vendor</th>
              <th>Locality</th>
              <th>Phone</th>
              <th>Scanner</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="vegTableBody">
            <tr><td colspan="8" style="text-align:center;color:gray;">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="cart">
        <h3>Your Cart</h3>
        <div id="cartItems"></div>
        <p><b>Total:</b> ₹ <span id="cartTotal">0</span></p>
        <button onclick="clearCart()">Clear</button>
        <button class="checkout" onclick="checkout()">Checkout</button>
      </div>
    </div>

    <button style="margin-top:20px;" onclick="logout()">Logout</button>
</div>

<script>
const session = JSON.parse(localStorage.getItem('session'));
if(!session || session.role !== 'user'){
    window.location.replace('index.html');
}

document.getElementById('welcomeText').innerText = `Welcome ${session.name || 'User'}!`;
document.getElementById('userPhone').innerText = session.phone || 'N/A';

let allItems = [];
let filtered = [];

async function loadVegetables(){
  try {
    const res = await fetch('http://localhost:5000/vegetables');
    allItems = await res.json();
    filtered = allItems.slice();
    renderTable(filtered);
  } catch(err){
    console.error('Error fetching vegetables:', err);
  }
}

function renderTable(list){
  const tbody = document.getElementById('vegTableBody');
  tbody.innerHTML = '';
  if(!list || !list.length){
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:gray;">No vegetables found</td></tr>';
    return;
  }
  list.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>₹ ${item.rate}</td>
      <td>${item.area}</td>
      <td>${item.vendor.name}</td>
      <td>${item.vendor.locality}</td>
      <td>${item.vendor.phone}</td>
      <td>${item.vendor.scannerCode}</td>
      <td><button onclick='addToCart(${JSON.stringify(itemToCartDTO(item)).replace(/"/g,"&quot;")})'>Add</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function itemToCartDTO(item){
  return {
    vegId: item._id,
    name: item.name,
    rate: item.rate,
    vendorPhone: item.vendor.phone,
    vendorName: item.vendor.name,
    vendorLocality: item.vendor.locality,
    area: item.area
  };
}

function applyFilters(){
  const fv = (document.getElementById('fVeg').value || '').toLowerCase();
  const fl = (document.getElementById('fLocality').value || '').toLowerCase();
  const fmin = document.getElementById('fMinRate').value;
  const fmax = document.getElementById('fMaxRate').value;

  filtered = allItems.filter(it => {
    const byVeg = !fv || it.name.toLowerCase().includes(fv);
    const byLoc = !fl || it.vendor.locality.toLowerCase().includes(fl) || it.area.toLowerCase().includes(fl);
    const byMin = !fmin || Number(it.rate) >= Number(fmin);
    const byMax = !fmax || Number(it.rate) <= Number(fmax);
    return byVeg && byLoc && byMin && byMax;
  });

  renderTable(filtered);
}

['fVeg','fLocality','fMinRate','fMaxRate'].forEach(id => {
  document.getElementById(id).addEventListener('input', applyFilters);
});
function getCart(){
  return JSON.parse(localStorage.getItem('cart') || '[]');
}
function setCart(cart){
  localStorage.setItem('cart', JSON.stringify(cart));
  renderCart();
}
function addToCart(item){
  const cart = getCart();
  const existing = cart.find(c => c.vegId === item.vegId && c.vendorPhone === item.vendorPhone);
  if(existing){ existing.qty += 1; }
  else { cart.push({ ...item, qty: 1 }); }
  setCart(cart);
}
function removeFromCart(idx){
  const cart = getCart();
  cart.splice(idx, 1);
  setCart(cart);
}
function updateQty(idx, delta){
  const cart = getCart();
  cart[idx].qty += delta;
  if(cart[idx].qty <= 0) cart.splice(idx, 1);
  setCart(cart);
}
function clearCart(){
  setCart([]);
}
function cartTotal(cart){
  return cart.reduce((sum, it) => sum + (Number(it.rate) * Number(it.qty)), 0);
}
function renderCart(){
  const cart = getCart();
  const wrap = document.getElementById('cartItems');
  wrap.innerHTML = '';
  if(!cart.length){
    wrap.innerHTML = '<p style="color:gray;">Cart is empty</p>';
    document.getElementById('cartTotal').innerText = '0';
    return;
  }
  cart.forEach((it, idx) => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `
      <div>
        <b>${it.name}</b> • ₹ ${it.rate} • ${it.qty} kg
        <br><small>${it.vendorName} (${it.vendorLocality}) • ${it.area}</small>
      </div>
      <div>
        <button onclick="updateQty(${idx}, -1)">-</button>
        <button onclick="updateQty(${idx}, +1)">+</button>
        <button onclick="removeFromCart(${idx})">x</button>
      </div>
    `;
    wrap.appendChild(div);
  });
  document.getElementById('cartTotal').innerText = cartTotal(cart);
}
function checkout(){
  const cart = getCart();
  if(!cart.length) return alert('Cart is empty');
  alert('Checkout is a demo! Items: ' + cart.length + ' • Total ₹ ' + cartTotal(cart));
}
function logout(){
  localStorage.removeItem('session');
  window.location.replace('index.html');
}
loadVegetables();
renderCart();
</script>
</body>
</html>
